<!DOCTYPE html>
<html lang="ru" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–î–æ–±–∞–≤–∏—Ç—å –≥–ª–∞–≤—É</title>
    <link rel="icon" type="image/x-icon" href="/favicon.ico">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container">
            <a class="navbar-brand" href="/manga">Manga Reader</a>
            <div class="navbar-nav">
                <a class="nav-link" href="/manga">–ö–∞—Ç–∞–ª–æ–≥</a>
                <a class="nav-link" href="/manga/create">–î–æ–±–∞–≤–∏—Ç—å –º–∞–Ω–≥—É</a>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <div class="row justify-content-center">
            <div class="col-md-8">
                <div class="card">
                    <div class="card-header">
                        <h3>–î–æ–±–∞–≤–∏—Ç—å –≥–ª–∞–≤—É –¥–ª—è "<span th:text="${manga.title}"></span>"</h3>
                    </div>
                    <div class="card-body">
                        <div th:if="${errorMessage}" class="alert alert-danger">
                            <span th:text="${errorMessage}"></span>
                        </div>

                        <form th:action="@{/chapters/create}" th:object="${chapterCreateDTO}" method="post" enctype="multipart/form-data">
                            <input type="hidden" name="mangaId" th:value="${manga.id}">

                            <div class="mb-3">
                                <label for="chapterNumber" class="form-label">–ù–æ–º–µ—Ä –≥–ª–∞–≤—ã *</label>
                                <input type="number" class="form-control" id="chapterNumber" th:field="*{chapterNumber}"
                                       min="1" required>
                                <div th:if="${#fields.hasErrors('chapterNumber')}" class="text-danger" th:errors="*{chapterNumber}"></div>
                            </div>

                            <div class="mb-3">
                                <label for="title" class="form-label">–ù–∞–∑–≤–∞–Ω–∏–µ –≥–ª–∞–≤—ã</label>
                                <input type="text" class="form-control" id="title" th:field="*{title}"
                                       placeholder="–ù–∞–ø—Ä–∏ÔøΩÔøΩ–µ—Ä: –ù–∞—á–∞–ª–æ –ø—Ä–∏–∫–ª—é—á–µ–ΩÔøΩÔøΩ—è">
                                <div class="form-text">–ù–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ–µ –ø–æ–ª–µ</div>
                            </div>

                            <div class="mb-3">
                                <label for="images" class="form-label">–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è —Å—Ç—Ä–∞–Ω–∏—Ü *</label>
                                <input type="file" class="form-control" id="images" name="images"
                                       multiple accept="image/*" required>
                                <div class="form-text">–í—ã–±–µ—Ä–∏—Ç–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –≤ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–º –ø–æ—Ä—è–¥–∫–µ. –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç—Å—è —Ñ–æ—Ä–º–∞—Ç—ã: JPG, PNG, GIF</div>
                            </div>

                            <div class="mb-3">
                                <label for="startPage" class="form-label">–ù–∞—á–∞–ª—å–Ω—ã–π –Ω–æ–º–µ—Ä —Å—Ç—Ä–∞–Ω–∏—Ü—ã</label>
                                <input type="number" class="form-control" id="startPage" name="startPage"
                                       min="1" value="1">
                                <div class="form-text">–° –∫–∞–∫–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü—ã –Ω–∞—á–∏–Ω–∞—Ç—å –Ω—É–º–µ—Ä–∞—Ü–∏—é –∑–∞–≥—Ä—É–∂–∞–µ–º—ã—Ö –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π</div>
                            </div>

                            <div class="mb-3">
                                <div id="preview-container" class="row g-2">
                                    <!-- –ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π –±—É–¥–µ—Ç –∑–¥–µ—Å—å -->
                                </div>
                                <div class="mt-2" id="reorder-hint" style="display: none;">
                                    <small class="text-info">üí° –ü–µ—Ä–µ—Ç–∞—â–∏—Ç–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –¥–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è ÔøΩÔøΩ–æ—Ä—è–¥–∫–∞ —Å—Ç—Ä–∞–Ω–∏—Ü</small>
                                </div>
                            </div>

                            <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                                <a th:href="@{/manga/{id}(id=${manga.id})}" class="btn btn-secondary">–û—Ç–º–µ–Ω–∞</a>
                                <button type="submit" class="btn btn-primary" id="submitBtn">–°–æ–∑–¥–∞—Ç—å –≥–ª–∞–≤—É</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>
    <script>
        let selectedFiles = [];
        let sortable = null;

        // –ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π —Å drag & drop
        document.getElementById('images').addEventListener('change', function(e) {
            selectedFiles = Array.from(e.target.files);
            updatePreview();
        });

        function updatePreview() {
            const previewContainer = document.getElementById('preview-container');
            const startPage = parseInt(document.getElementById('startPage').value) || 1;
            previewContainer.innerHTML = '';

            if (selectedFiles.length === 0) {
                const reorderHint = document.getElementById('reorder-hint');
                reorderHint.style.display = 'none';
                return;
            }

            selectedFiles.forEach((file, index) => {
                if (file && file.type.startsWith('image/')) {
                    const reader = new FileReader();

                    reader.onload = function(e) {
                        const col = document.createElement('div');
                        col.className = 'col-6 col-md-3 sortable-item';
                        col.setAttribute('data-index', index);
                        col.innerHTML = `
                            <div class="card draggable-card" style="cursor: move;">
                                <div class="position-relative">
                                    <img src="${e.target.result}" class="card-img-top" style="height: 150px; object-fit: cover;">
                                    <div class="position-absolute top-0 end-0 m-1">
                                        <span class="badge bg-primary">‚Ññ${startPage + index}</span>
                                    </div>
                                    <div class="position-absolute top-0 start-0 m-1">
                                        <span class="badge bg-secondary">üìã</span>
                                    </div>
                                </div>
                                <div class="card-body p-2">
                                    <small class="text-muted">–°—Ç—Ä–∞–Ω–∏—Ü–∞ ${startPage + index}</small>
                                    <div class="mt-1">
                                        <button type="button" class="btn btn-outline-danger btn-sm" onclick="removeImage(${index})" title="–£–¥–∞–ª–∏—Ç—å">
                                            <small>‚ùå</small>
                                        </button>
                                        <button type="button" class="btn btn-outline-info btn-sm" onclick="previewFullImage('${e.target.result}', ${startPage + index})" title="–£–≤–µ–ª–∏—á–∏—Ç—å">
                                            <small>üîç</small>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        `;
                        previewContainer.appendChild(col);

                        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º Sortable –ø–æ—Å–ª–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –≤—Å–µ—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤
                        if (index === selectedFiles.length - 1) {
                            initializeSortable();
                        }
                    };

                    reader.readAsDataURL(file);
                }
            });

            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–æ–¥—Å–∫–∞–∑–∫—É –ø–æ –ø–µ—Ä–µ—É–ø–æ—Ä—è–¥–æ—á–∏–≤–∞–Ω–∏—é
            const reorderHint = document.getElementById('reorder-hint');
            if (selectedFiles.length > 1) {
                reorderHint.style.display = 'block';
            } else {
                reorderHint.style.display = 'none';
            }
        }

        function initializeSortable() {
            const previewContainer = document.getElementById('preview-container');

            // –£–Ω–∏—á—Ç–æ–∂–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–π —ç–∫–∑–µ–º–ø–ª—è—Ä
            if (sortable) {
                sortable.destroy();
            }

            sortable = Sortable.create(previewContainer, {
                animation: 150,
                ghostClass: 'sortable-ghost',
                chosenClass: 'sortable-chosen',
                dragClass: 'sortable-drag',
                onEnd: function(evt) {
                    // –ü–µ—Ä–µ—É–ø–æ—Ä—è–¥–æ—á–∏–≤–∞–µ–º –º–∞—Å—Å–∏–≤ —Ñ–∞–π–ª–æ–≤
                    const item = selectedFiles.splice(evt.oldIndex, 1)[0];
                    selectedFiles.splice(evt.newIndex, 0, item);

                    // –û–±–Ω–æ–≤–ª—è–µ–º –Ω–æ–º–µ—Ä–∞ —Å—Ç—Ä–∞–Ω–∏—Ü
                    updatePageNumbers();
                }
            });
        }

        function updatePageNumbers() {
            const startPage = parseInt(document.getElementById('startPage').value) || 1;
            const cards = document.querySelectorAll('.sortable-item');

            cards.forEach((card, index) => {
                const badge = card.querySelector('.badge.bg-primary');
                const pageText = card.querySelector('.card-body small');

                if (badge) badge.textContent = `‚Ññ${startPage + index}`;
                if (pageText) pageText.textContent = `–°—Ç—Ä–∞–Ω–∏—Ü–∞ ${startPage + index}`;
            });
        }

        function removeImage(index) {
            selectedFiles.splice(index, 1);
            updatePreview();
            updateFileInput();
        }

        function updateFileInput() {
            const input = document.getElementById('images');
            const dt = new DataTransfer();

            selectedFiles.forEach(file => {
                dt.items.add(file);
            });

            input.files = dt.files;
        }

        function previewFullImage(src, pageNumber) {
            const modal = document.createElement('div');
            modal.className = 'modal fade';
            modal.innerHTML = `
                <div class="modal-dialog modal-lg">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">–°—Ç—Ä–∞–Ω–∏—Ü–∞ ${pageNumber}</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body text-center">
                            <img src="${src}" class="img-fluid" style="max-height: 70vh;">
                        </div>
                    </div>
                </div>
            `;

            document.body.appendChild(modal);
            const bsModal = new bootstrap.Modal(modal);
            bsModal.show();

            modal.addEventListener('hidden.bs.modal', () => {
                document.body.removeChild(modal);
            });
        }

        // –û–±–Ω–æ–≤–ª—è–µ–º –Ω–æ–º–µ—Ä–∞ —Å—Ç—Ä–∞–Ω–∏—Ü –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–ΩÔøΩÔøΩ–∏ —Å—Ç–∞—Ä—Ç–æ–≤–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        document.getElementById('startPage').addEventListener('change', function() {
            updatePageNumbers();
        });

        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ —Ñ–æ—Ä–º—ã
        document.querySelector('form').addEventListener('submit', function(e) {
            // –í–ê–ñ–ù–û: –û–±–Ω–æ–≤–ª—è–µ–º —Ñ–∞–π–ª—ã –≤ input –ø–µ—Ä–µ–¥ –æ—Ç–ø—Ä–∞–≤–∫–æ–π —Ñ–æ—Ä–º—ã
            updateFileInput();

            console.log('=== DEBUG: Form submission ===');
            console.log('selectedFiles order:');
            selectedFiles.forEach((file, index) => {
                console.log(`File ${index}: ${file.name} (will be page ${parseInt(document.getElementById('startPage').value) + index})`);
            });

            const submitBtn = document.getElementById('submitBtn');
            submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status"></span> –°–æ–∑–¥–∞–Ω–∏–µ...';
            submitBtn.disabled = true;
        });
    </script>

    <style>
        .draggable-card {
            transition: transform 0.2s ease;
        }

        .draggable-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }

        .sortable-ghost {
            opacity: 0.4;
        }

        .sortable-chosen {
            transform: rotate(5deg);
        }

        .sortable-drag {
            transform: rotate(5deg);
            box-shadow: 0 8px 16px rgba(0,0,0,0.2);
        }

        .sortable-item {
            user-select: none;
        }
    </style>
</body>
</html>
