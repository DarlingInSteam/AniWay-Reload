<!DOCTYPE html>
<html lang="ru" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title th:text="${manga.title}">–î–µ—Ç–∞–ª–∏ –º–∞–Ω–≥–∏</title>
    <link rel="icon" type="image/x-icon" href="/favicon.ico">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container">
            <a class="navbar-brand" href="/manga">Manga Reader</a>
            <div class="navbar-nav">
                <a class="nav-link" href="/manga">–ö–∞—Ç–∞–ª–æ–≥</a>
                <a class="nav-link" href="/manga/create">–î–æ–±–∞–≤–∏—Ç—å –º–∞–Ω–≥—É</a>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <div th:if="${successMessage}" class="alert alert-success alert-dismissible fade show" role="alert">
            <span th:text="${successMessage}"></span>
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>

        <div th:if="${errorMessage}" class="alert alert-danger alert-dismissible fade show" role="alert">
            <span th:text="${errorMessage}"></span>
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>

        <div class="row">
            <div class="col-md-4">
                <img th:src="${manga.coverImageUrl}"
                     th:alt="${manga.title}"
                     class="img-fluid rounded shadow"
                     th:if="${manga.coverImageUrl}"
                     onerror="this.src='/images/default-cover.svg'">
                <div class="bg-light rounded shadow d-flex align-items-center justify-content-center"
                     style="height: 400px;" th:unless="${manga.coverImageUrl}">
                    <span class="text-muted">–ù–µ—Ç –æ–±–ª–æ–∂–∫–∏</span>
                </div>
            </div>

            <div class="col-md-8">
                <div class="d-flex justify-content-between align-items-start mb-3">
                    <h1 th:text="${manga.title}">–ù–∞–∑–≤–∞–Ω–∏–µ –º–∞–Ω–≥–∏</h1>
                    <div>
                        <a th:href="@{/manga/{id}/edit(id=${manga.id})}" class="btn btn-outline-primary">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</a>
                        <form th:action="@{/manga/{id}/delete(id=${manga.id})}" method="post" class="d-inline">
                            <button type="submit" class="btn btn-outline-danger"
                                    onclick="return confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç—É –º–∞–Ω–≥—É?')">–£–¥–∞–ª–∏—Ç—å</button>
                        </form>
                    </div>
                </div>

                <div class="mb-3">
                    <h5>–û–ø–∏—Å–∞–Ω–∏–µ:</h5>
                    <p th:text="${manga.description}" class="text-muted">–û–ø–∏—Å–∞–Ω–∏–µ –º–∞–Ω–≥–∏...</p>
                </div>

                <div class="row mb-3">
                    <div class="col-sm-6">
                        <strong>–ê–≤—Ç–æ—Ä:</strong> <span th:text="${manga.author ?: '–ù–µ–∏–∑–≤–µ—Å—Ç–µ–Ω'}"></span>
                    </div>
                    <div class="col-sm-6" th:if="${manga.artist}">
                        <strong>–•—É–¥–æ–∂–Ω–∏–∫:</strong> <span th:text="${manga.artist}"></span>
                    </div>
                </div>

                <div class="row mb-3">
                    <div class="col-sm-6">
                        <strong>–°—Ç–∞—Ç—É—Å:</strong>
                        <span class="badge" th:classappend="${manga.status.name() == 'COMPLETED'} ? 'bg-success' :
                                                           (${manga.status.name() == 'ONGOING'} ? 'bg-primary' :
                                                           (${manga.status.name() == 'HIATUS'} ? 'bg-warning' : 'bg-danger'))"
                              th:text="${manga.status}"></span>
                    </div>
                    <div class="col-sm-6">
                        <strong>–í—Å–µ–≥–æ –≥–ª–∞–≤:</strong> <span th:text="${manga.totalChapters}">0</span>
                    </div>
                </div>

                <div class="row mb-3" th:if="${manga.releaseDate}">
                    <div class="col-sm-6">
                        <strong>–î–∞—Ç–∞ –≤—ã—Ö–æ–¥–∞:</strong> <span th:text="${#temporals.format(manga.releaseDate, 'dd.MM.yyyy')}"></span>
                    </div>
                    <div class="col-sm-6" th:if="${manga.genre}">
                        <strong>–ñ–∞–Ω—Ä:</strong> <span th:text="${manga.genre}"></span>
                    </div>
                </div>
            </div>
        </div>

        <hr class="my-4">

        <div class="d-flex justify-content-between align-items-center mb-3">
            <h3>–ì–ª–∞–≤—ã</h3>
            <a th:href="@{/chapters/create?mangaId={id}(id=${manga.id})}" class="btn btn-success">–î–æ–±–∞–≤–∏—Ç—å –≥–ª–∞–≤—É</a>
        </div>

        <div id="chapters-list">
            <p class="text-muted">–ó–∞–≥—Ä—É–∑–∫–∞ –≥–ª–∞–≤...</p>
        </div>
    </div>

    <!-- Modal –¥–ª—è –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –≥–ª–∞–≤—ã -->
    <div class="modal fade" id="previewModal" tabindex="-1" aria-labelledby="previewModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="previewModalLabel">–ü—Ä–µ–¥ÔøΩÔøΩ—Ä–æ—Å–º–æ—Ç—Ä –≥–ª–∞–≤—ã</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div id="preview-content">
                        <div class="text-center">
                            <div class="spinner-border" role="status">
                                <span class="visually-hidden">–ó–∞–≥—Ä—É–∑–∫–∞...</span>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">–ó–∞–∫—Ä—ã—Ç—å</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // –ó–∞–≥—Ä—É–∑–∫–∞ —Å–ø–∏—Å–∫–∞ –≥–ª–∞–≤ —á–µ—Ä–µ–∑ API
        fetch(`/api/manga/${[[${manga.id}]]}/chapters`)
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.json();
            })
            .then(chapters => {
                const chaptersDiv = document.getElementById('chapters-list');

                // –£–±–µ–∂–¥–∞–µ–º—Å—è, —á—Ç–æ chapters —è–≤–ª—è–µ—Ç—Å—è –º–∞—Å—Å–∏–≤–æ–º
                if (!Array.isArray(chapters)) {
                    console.error('Received data is not an array:', chapters);
                    chaptersDiv.innerHTML = '<div class="alert alert-danger">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –≥–ª–∞–≤. –ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –¥–∞–Ω–Ω—ã—Ö.</div>';
                    return;
                }

                if (chapters.length === 0) {
                    chaptersDiv.innerHTML = '<p class="text-muted">–ü–æ–∫–∞ –Ω–µ—Ç –¥–æ–±–∞–≤–ª–µ–Ω–Ω—ã—Ö –≥–ª–∞–≤.</p>';
                } else {
                    let chaptersHtml = '<div class="list-group">';
                    chapters.forEach(chapter => {
                        chaptersHtml += `
                            <div class="list-group-item d-flex justify-content-between align-items-center">
                                <div>
                                    <h6 class="mb-1">–ì–ª–∞–≤–∞ ${chapter.chapterNumber}</h6>
                                    <p class="mb-1">${chapter.title || '–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è'}</p>
                                    <small class="text-muted">–°—Ç—Ä–∞–Ω–∏—Ü: ${chapter.pageCount || 0} | ${chapter.publishedDate ? new Date(chapter.publishedDate).toLocaleDateString('ru-RU') : '–ù–µ—Ç –¥–∞—Ç—ã'}</small>
                                </div>
                                <div class="btn-group" role="group">
                                    <button type="button" class="btn btn-outline-info btn-sm" onclick="showChapterPreview(${chapter.id})" title="–ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä">
                                        üëÅÔ∏è
                                    </button>
                                    <a href="/reader/${chapter.id}" class="btn btn-primary btn-sm">–ß–∏—Ç–∞—Ç—å</a>
                                    <button type="button" class="btn btn-outline-danger btn-sm" onclick="deleteChapter(${chapter.id}, ${chapter.chapterNumber})" title="–£–¥–∞–ª–∏—Ç—å">
                                        üóëÔ∏è
                                    </button>
                                </div>
                            </div>`;
                    });
                    chaptersHtml += '</div>';
                    chaptersDiv.innerHTML = chaptersHtml;
                }
            })
            .catch(error => {
                console.error('Error loading chapters:', error);
                document.getElementById('chapters-list').innerHTML =
                    '<div class="alert alert-danger">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –≥–ª–∞–≤. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ ChapterService –∑–∞–ø—É—â–µ–Ω.</div>';
            });

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–∫–∞–∑–∞ –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –≥–ª–∞–≤—ã
        function showChapterPreview(chapterId) {
            const modal = new bootstrap.Modal(document.getElementById('previewModal'));
            const previewContent = document.getElementById('preview-content');

            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É
            previewContent.innerHTML = `
                <div class="text-center">
                    <div class="spinner-border" role="status">
                        <span class="visually-hidden">–ó–∞–≥—Ä—É–∑–∫–∞...</span>
                    </div>
                    <p class="mt-2">–ó–∞–≥—Ä—É–∂–∞–µ–º –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä...</p>
                </div>
            `;

            modal.show();

            // –ó–∞–≥—Ä—É–∂–∞–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –≥–ª–∞–≤—ã
            fetch(`/api/images/chapter/${chapterId}/preview`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Failed to load preview');
                    }
                    return response.json();
                })
                .then(images => {
                    if (images.length === 0) {
                        previewContent.innerHTML = '<p class="text-center text-muted">–í —ç—Ç–æ–π –≥–ª–∞–≤–µ –ø–æ–∫–∞ –Ω–µ—Ç –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π.</p>';
                        return;
                    }

                    let previewHtml = '<div class="row g-3">';
                    images.forEach((image, index) => {
                        previewHtml += `
                            <div class="col-6 col-md-4 col-lg-3">
                                <div class="card">
                                    <img src="/api/images/proxy/${image.imageKey}"
                                         class="card-img-top"
                                         style="height: 200px; object-fit: cover;"
                                         alt="–°—Ç—Ä–∞–Ω–∏—Ü–∞ ${image.pageNumber}"
                                         loading="lazy">
                                    <div class="card-body p-2">
                                        <small class="text-muted">–°—Ç—Ä–∞–Ω–∏—Ü–∞ ${image.pageNumber}</small>
                                    </div>
                                </div>
                            </div>
                        `;
                    });
                    previewHtml += '</div>';
                    previewContent.innerHTML = previewHtml;
                })
                .catch(error => {
                    console.error('Error loading preview:', error);
                    previewContent.innerHTML = `
                        <div class="alert alert-danger">
                            <h6>–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä–∞</h6>
                            <p>–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –≥–ª–∞–≤—ã. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ ImageStorageService –∑–∞–ø—É—â–µ–Ω.</p>
                        </div>
                    `;
                });
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è –≥–ª–∞–≤—ã
        function deleteChapter(chapterId, chapterNumber) {
            if (confirm(`–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å –≥–ª–∞–≤—É ${chapterNumber}? –í—Å–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è —ç—Ç–æ–π –≥–ª–∞–≤—ã –±—É–¥—É—Ç —Ç–∞–∫–∂–µ —É–¥–∞–ª–µ–Ω—ã.`)) {
                fetch(`/chapters/${chapterId}`, {
                    method: 'DELETE'
                })
                .then(response => {
                    if (response.ok) {
                        // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —Å–ø–∏—Å–æ–∫ –≥–ª–∞–≤
                        location.reload();
                    } else {
                        response.text().then(errorText => {
                            alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –≥–ª–∞–≤—ã: ' + errorText);
                        });
                    }
                })
                .catch(error => {
                    console.error('Error deleting chapter:', error);
                    alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –≥–ª–∞–≤—ã: ' + error.message);
                });
            }
        }
    </script>
</body>
</html>
