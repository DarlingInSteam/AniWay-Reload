server:
  port: 8080
  forward-headers-strategy: native

auth:
  introspect-url: "http://auth-service:8085/api/auth/validate"
  public-paths: "/api/auth/**,/auth/**,/api/health/**,/api/public/**,/parser,/parser/**,/api/parser/**,/api/parser/progress/**,/manga,/manga/**,/api/genres/**,/api/tags/**,/api/notifications/stream,/api/levels/**,/api/import-queue/**,/telegram/**"
  cache-ttl-seconds: 300

ratelimit:
  anon:
    burst: 60
    refill: 30
  user:
    burst: 300
    refill: 150
  admin:
    burst: 600
    refill: 300
  connection:
    max-per-user: 5
    max-per-ip: 3
    key-ttl-seconds: 45

spring:
  application:
    name: gateway-service
  servlet:
    multipart:
      max-file-size: 200MB
      max-request-size: 2GB
  data:
    redis:
      host: ${REDIS_HOST:localhost}
      port: ${REDIS_PORT:6379}
      password: ${REDIS_PASSWORD:}
      timeout: 5s

  cloud:
    gateway:
      # Маршруты к микросервисам
      routes:
        # MangaService - WebSocket endpoints (НАИВЫСШИЙ ПРИОРИТЕТ)
        - id: manga-websocket
          uri: ws://manga-service:8081
          predicates:
            - Path=/api/manga/ws/**
          filters:
            - StripPrefix=3  # Исправляем: удаляем /api/manga/ws, оставляем /progress
          order: 0

        # AuthService - Authentication and user management (HIGH PRIORITY)
        - id: auth-api
          uri: http://auth-service:8085
          predicates:
            - Path=/api/auth/**
          filters:
            - StripPrefix=0
          order: 1

        # AuthService - Alternate path without /api prefix (backward compatibility / potential client mismatch)
        - id: auth-api-alt
          uri: http://auth-service:8085
          predicates:
            - Path=/auth/**
          filters:
            - StripPrefix=0
          order: 1

        # AuthService - User management
        - id: users-api
          uri: http://auth-service:8085
          predicates:
            - Path=/api/users/**
          filters:
            - StripPrefix=0
          order: 2

        # AuthService - Bookmarks
        - id: bookmarks-api
          uri: http://auth-service:8085
          predicates:
            - Path=/api/bookmarks/**
          filters:
            - StripPrefix=0
          order: 3

        # AuthService - Reading progress
        - id: progress-api
          uri: http://auth-service:8085
          predicates:
            - Path=/api/progress/**
          filters:
            - StripPrefix=0
          order: 4

        # AuthService - Admin utilities
        - id: admin-utils-api
          uri: http://auth-service:8085
          predicates:
            - Path=/api/admin/**
          filters:
            - StripPrefix=0
          order: 5

        # CommentService - Comments API
        - id: comments-api
          uri: http://comment-service:8086
          predicates:
            - Path=/api/comments/**
          filters:
            - StripPrefix=0
          order: 6

        # MomentService - Moments API
        - id: moments-upload
          uri: http://image-storage-service:8083
          predicates:
            - Path=/api/moments/upload
          filters:
            - RewritePath=/api/moments/upload, /api/images/moments
          order: 5

        - id: moments-api
          uri: http://moment-service:8099
          predicates:
            - Path=/api/moments/**
          filters:
            - StripPrefix=0
          order: 6

        # FriendService - Friends API
        - id: friends-api
          uri: http://friend-service:8102
          predicates:
            - Path=/api/friends/**
          filters:
            - StripPrefix=0
          order: 6

        # MessageService - Messaging API
        - id: messages-api
          uri: http://message-service:8103
          predicates:
            - Path=/api/messages/**
          filters:
            - StripPrefix=0
          order: 6

        # PostService - Posts API
        - id: posts-api
          uri: http://post-service:8097
          predicates:
            - Path=/api/posts/**
          filters:
            - StripPrefix=0
          order: 6

        # ForumService - Forum API
        - id: forum-api
          uri: http://forum-service:8087
          predicates:
            - Path=/api/forum/**
          filters:
            - StripPrefix=0
          order: 6

        # MangaService - Parser API endpoints (ВЫСОКИЙ ПРИОРИТЕТ)
        - id: manga-parser
          uri: http://manga-service:8081
          predicates:
            - Path=/api/parser/**
          filters:
            - StripPrefix=1
          order: 7

        # MangaService - Parser Web UI (веб-интерфейс парсера)
        - id: manga-parser-web
          uri: http://manga-service:8081
          predicates:
            - Path=/parser,/parser/**
          filters:
            - StripPrefix=0
          order: 8

        # MangaService - API endpoints
        - id: manga-api
          uri: http://manga-service:8081
          predicates:
            - Path=/api/manga/**
          filters:
            - StripPrefix=0
          order: 9

        # MangaService - Genres API
        - id: genres-api
          uri: http://manga-service:8081
          predicates:
            - Path=/api/genres/**
          filters:
            - StripPrefix=0
          order: 9

        # MangaService - Tags API  
        - id: tags-api
          uri: http://manga-service:8081
          predicates:
            - Path=/api/tags/**
          filters:
            - StripPrefix=0
          order: 10

        # MangaService - Import Queue API
        - id: import-queue-api
          uri: http://manga-service:8081
          predicates:
            - Path=/api/import-queue/**
          filters:
            - StripPrefix=0
          order: 11

        # MangaService - Web UI (Thymeleaf страницы)
        - id: manga-web
          uri: http://manga-service:8081
          predicates:
            - Path=/manga,/manga/**
          filters:
            - StripPrefix=0

        # MangaService - Reader
        - id: manga-reader
          uri: http://manga-service:8081
          predicates:
            - Path=/reader/**
          filters:
            - StripPrefix=0

        # MangaService - Chapters Web UI
        - id: chapters-web
          uri: http://manga-service:8081
          predicates:
            - Path=/chapters/**
          filters:
            - StripPrefix=0

        # ChapterService - API endpoints
        - id: chapter-api
          uri: http://chapter-service:8082
          predicates:
            - Path=/api/chapters/**
          filters:
            - StripPrefix=0

        # ImageStorageService - API endpoints
        - id: images-api
          uri: http://image-storage-service:8083
          predicates:
            - Path=/api/images/**
          filters:
            - StripPrefix=0

        # NotificationService - API endpoints
        - id: notification-api
          uri: http://notification-service:8095
          predicates:
            - Path=/api/notifications/**
          filters:
            - StripPrefix=0

        # NotificationService - Telegram webhook endpoint
        - id: notification-telegram-webhook
          uri: http://notification-service:8095
          predicates:
            - Path=/telegram/**
          filters:
            - StripPrefix=0

        # LevelService - XP & Level endpoints (add /api prefix for consistency)
        - id: level-api
          uri: http://level-service:8098
          predicates:
            - Path=/api/levels/**
          filters:
            - StripPrefix=1

        # Статические ресурсы MangaService (favicon, CSS, JS)
        - id: manga-static
          uri: http://manga-service:8081
          predicates:
            - Path=/favicon.ico,/static/**,/css/**,/js/**,/images/**
          filters:
            - StripPrefix=0

        # MelonService - Direct parser API endpoints (обходной маршрут)
        - id: melon-direct
          uri: http://parser-service:8084
          predicates:
            - Path=/api/melon/**
          filters:
            - StripPrefix=2

      # Настройки тайм-аутов
      httpclient:
        connect-timeout: 10000
        response-timeout: 7200000  # Увеличиваем до 2 часов для долгих операций парсинга и импорта

# Actuator для мониторинга
management:
  endpoints:
    web:
      exposure:
        include: health,info,gateway,prometheus
  endpoint:
    prometheus:
      enabled: true
    health:
      show-details: when-authorized
  metrics:
    export:
      prometheus:
        enabled: true
    tags:
      application: ${spring.application.name}
    distribution:
      percentiles-histogram:
        http:
          server:
            requests: true
      percentiles:
        http:
          server:
            requests:
              - 0.5
              - 0.9
              - 0.95
              - 0.99

# Логирование
logging:
  level:
    '[org.springframework.cloud.gateway]': INFO
    '[org.springframework.web.cors]': INFO
    '[shadowshift.studio.gatewayservice]': INFO
  pattern:
    console: "%d{HH:mm:ss.SSS} [%thread] %-5level [%logger{36}] - %msg%n"

---
spring:
  config:
    activate:
      on-profile: dev
  cloud:
    gateway:
      globalcors:
        cors-configurations:
          '[/**]':
            allowed-origin-patterns:
              - "http://localhost:*"
              - "http://127.0.0.1:*"
              - "http://192.168.*.*:*"
              - "http://10.*.*.*:*"
              - "http://172.16.*.*:*"
              - "http://172.17.*.*:*"
              - "http://172.18.*.*:*"
            allowed-methods:
              - GET
              - POST
              - PUT
              - DELETE
              - PATCH
              - OPTIONS
              - HEAD
            allowed-headers:
              - Authorization
              - Content-Type
              - X-Requested-With
              - X-Csrf-Token
            exposed-headers:
              - X-RateLimit-Limit
              - X-RateLimit-Remaining
              - X-RateLimit-Role
              - Retry-After
            allow-credentials: true
            max-age: 3600

---
spring:
  config:
    activate:
      on-profile: prod
  cloud:
    gateway:
      globalcors:
        cors-configurations:
          '[/**]':
            allowed-origins:
              - "https://aniway.space"
              - "https://www.aniway.space"
            allowed-methods:
              - GET
              - POST
              - PUT
              - DELETE
              - PATCH
              - OPTIONS
            allowed-headers:
              - Authorization
              - Content-Type
              - X-Requested-With
              - X-Csrf-Token
            exposed-headers:
              - X-RateLimit-Limit
              - X-RateLimit-Remaining
              - X-RateLimit-Role
              - Retry-After
            allow-credentials: false
            max-age: 600
