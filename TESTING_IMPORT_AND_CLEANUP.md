# Инструкция по проверке исправлений импорта и очистки

## Что было исправлено

✅ Регистронезависимая проверка статуса (`COMPLETED` vs `completed`)  
✅ Добавлен импорт манги в БД после успешного build  
✅ Добавлена очистка данных из MelonService после импорта

## Шаги для тестирования

### 1. Пересборка и перезапуск

```powershell
# Пересборка MangaService
cd c:\project\AniWayImageSystem\AniWay-Reload
docker build -t aniway-reload-manga-service -f MangaService/Dockerfile.dev MangaService

# Перезапуск контейнера
docker-compose restart manga-service

# Проверка логов
docker-compose logs -f manga-service
```

### 2. Запуск автопарсинга

Используйте API или админ-панель для запуска автопарсинга с `limit=1`.

### 3. Ожидаемое поведение

#### **Логи MangaService должны показать:**

```
INFO: Билд завершен для slug=xxx, запускаем импорт
INFO: Импорт завершен для slug=xxx, очищаем данные из MelonService
INFO: Данные успешно удалены из MelonService для slug=xxx
INFO: Полный парсинг завершен успешно! JSON, изображения импортированы, данные очищены.
```

#### **Прогресс на фронтенде:**

- 5% - Ожидание парсинга JSON
- 50% - Парсинг JSON завершен
- 60% - Скачивание изображений запущено
- **70% - Импорт в БД запущен** ← НОВОЕ
- **95% - Очистка данных из MelonService** ← НОВОЕ
- 100% - Полное завершение

#### **Логи MelonService должны показать:**

```
INFO: Progress sent to MangaService: {'status': 'COMPLETED', 'progress': 100, ...}
INFO: 172.18.0.12 - "DELETE /delete/xxx HTTP/1.1" 200 OK  ← НОВОЕ
```

### 4. Проверка результата

#### ✅ Манга импортирована в БД
```sql
SELECT * FROM mangas WHERE slug = 'xxx';
-- Должна появиться новая манга
```

#### ✅ Данные удалены из MelonService
```bash
# Проверить через API MelonService
curl http://localhost:8084/info/xxx
# Должен вернуть 404 или ошибку "не найдено"
```

#### ✅ Нет зависания процесса
- Процесс должен завершиться за разумное время (парсинг + build + импорт)
- Не должно быть бесконечных логов "Ожидание задачи... статус: COMPLETED"

### 5. Проверка ошибок

Если импорт или очистка упадут с ошибкой:

```
ERROR: Ошибка при импорте или очистке для slug=xxx: ...
updateFullParsingTask: status=failed, message="Ошибка при импорте: ..."
```

## Что делать при проблемах

### Проблема 1: Импорт не запускается
**Проверить:**
- Логи должны показывать `"Build завершен для slug=xxx, запускаем импорт"`
- Если этого нет → проверить регистр статуса в логах MelonService

### Проблема 2: Очистка не происходит
**Проверить:**
- Логи должны показывать `"Импорт завершен для slug=xxx, очищаем данные из MelonService"`
- Проверить endpoint `/delete/xxx` в MelonService

### Проблема 3: Процесс падает с ошибкой
**Проверить:**
- Полный стектрейс ошибки в логах
- Доступность MelonService
- Наличие данных в JSON файле

## Дополнительно

### Проверка 429 ошибок

Если в логах появляются `429 Too Many Requests`:
- См. документацию в LEADERBOARDS.md (раздел про rate limiting)
- Нужно будет добавить delay между запросами слайдов

### Мониторинг прогресса

Открыть фронтенд и следить за:
- Real-time логами (компонент LogViewer)
- Прогресс-баром (должен плавно идти от 0% до 100%)
- Финальным сообщением: "Полный парсинг завершен успешно! JSON, изображения импортированы, данные очищены."
