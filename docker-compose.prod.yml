services:
  # Frontend
  aniway-frontend:
    build:
      context: ./AniWayFrontend
      dockerfile: Dockerfile
    environment:
      - NODE_ENV=production
    expose:
      - "80"
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: "0.45"
          memory: 320M
        reservations:
          cpus: "0.20"
          memory: 160M
    networks:
      - backend

  # TLS reverse proxy
  reverse-proxy:
    image: caddy:2-alpine
    restart: unless-stopped
    ports:
      - "80:80"
      - "443:443"
    environment:
      - ACME_EMAIL=${ACME_EMAIL:?ACME_EMAIL not set}
      - ADMIN_PANEL_USER=${ADMIN_PANEL_USER:?ADMIN_PANEL_USER not set}
      - ADMIN_PANEL_PASSWORD_HASH=${ADMIN_PANEL_PASSWORD_HASH:?ADMIN_PANEL_PASSWORD_HASH not set}
    volumes:
      - ./deployment/Caddyfile:/etc/caddy/Caddyfile:ro
      - ./deployment/site-verifications:/srv/verifications:ro
      - caddy_data:/data
      - caddy_config:/config
    deploy:
      resources:
        limits:
          cpus: "0.50"
          memory: 384M
        reservations:
          cpus: "0.20"
          memory: 160M
    depends_on:
      - aniway-frontend
    networks:
      - edge
      - backend

  # Gateway Service
  gateway-service:
    build:
      context: ./GateWayService
      dockerfile: Dockerfile
    expose:
      - "8080"
    environment:
      - SPRING_PROFILES_ACTIVE=prod
      - EUREKA_CLIENT_ENABLED=false
      - POST_SERVICE_URL=http://post-service:8097
      - LEVEL_SERVICE_URL=http://level-service:8098
      - SPRING_DATA_REDIS_HOST=redis
      - SPRING_DATA_REDIS_PORT=6379
      - MANAGEMENT_ENDPOINTS_WEB_EXPOSURE_INCLUDE=health,info,prometheus,metrics
      - MANAGEMENT_ENDPOINT_PROMETHEUS_ENABLED=true
      - MANAGEMENT_METRICS_EXPORT_PROMETHEUS_ENABLED=true
      - MANAGEMENT_ENDPOINT_HEALTH_SHOW_DETAILS=always
    labels:
      - "prometheus.scrape=true"
      - "prometheus.job=aniway-backend"
      - "prometheus.metrics_path=/actuator/prometheus"
      - "prometheus.port=8080"
      - "prometheus.instance=gateway-service"
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: "1.25"
          memory: 1536M
        reservations:
          cpus: "0.50"
          memory: 640M
    depends_on:
      - auth-service
      - manga-service
      - comment-service
      - friend-service
      - message-service
      - chapter-service
      - image-storage-service
      - moment-service
      - forum-service
      - parser-service
      - post-service
      - level-service
      - rabbitmq
      - redis
    networks:
      - backend

  # Auth Service
  auth-service:
    build:
      context: ./AuthService
      dockerfile: Dockerfile
    environment:
      SPRING_PROFILES_ACTIVE: prod
      SPRING_DATASOURCE_URL: "jdbc:postgresql://auth-postgres:5432/${AUTH_POSTGRES_DB:?AUTH_POSTGRES_DB not set}"
      SPRING_DATASOURCE_USERNAME: "${AUTH_POSTGRES_USER:?AUTH_POSTGRES_USER not set}"
      SPRING_DATASOURCE_PASSWORD: "${AUTH_POSTGRES_PASSWORD:?AUTH_POSTGRES_PASSWORD not set}"
      TELEGRAM_BOT_USERNAME: "${TELEGRAM_BOT_USERNAME:?TELEGRAM_BOT_USERNAME not set}"
      TELEGRAM_DEEP_LINK_BASE: "${TELEGRAM_DEEP_LINK_BASE:?TELEGRAM_DEEP_LINK_BASE not set}"
      TELEGRAM_LINK_TTL_MINUTES: "${TELEGRAM_LINK_TTL_MINUTES:?TELEGRAM_LINK_TTL_MINUTES not set}"
      TELEGRAM_LINK_MAX_ACTIVE_TOKENS: "${TELEGRAM_LINK_MAX_ACTIVE_TOKENS:?TELEGRAM_LINK_MAX_ACTIVE_TOKENS not set}"
      TELEGRAM_NOTIFICATIONS_DEFAULT_ENABLED: "${TELEGRAM_NOTIFICATIONS_DEFAULT_ENABLED:?TELEGRAM_NOTIFICATIONS_DEFAULT_ENABLED not set}"
      # --- Resend SMTP Configuration ---
      MAIL_HOST: smtp.resend.com
      MAIL_PORT: 587
      MAIL_USERNAME: resend
      MAIL_PASSWORD: "${MAIL_PASSWORD:?MAIL_PASSWORD not set}"
      MAIL_AUTH: "true"
      MAIL_STARTTLS: "true"
      MAIL_STARTTLS_REQUIRED: "true"
      MAIL_SSL_TRUST: smtp.resend.com
      MAIL_CONNECTION_TIMEOUT: 5000
      MAIL_TIMEOUT: 5000
      MAIL_WRITE_TIMEOUT: 5000
      MAIL_DEBUG: "false"
      EMAIL_VERIFICATION_ENABLED: "true"
      EMAIL_VERIFICATION_FROM: noreply@aniway.space
      MANAGEMENT_ENDPOINTS_WEB_EXPOSURE_INCLUDE: health,info,prometheus,metrics
      MANAGEMENT_ENDPOINT_PROMETHEUS_ENABLED: "true"
      MANAGEMENT_METRICS_EXPORT_PROMETHEUS_ENABLED: "true"
      MANAGEMENT_ENDPOINT_HEALTH_SHOW_DETAILS: always
    labels:
      - "prometheus.scrape=true"
      - "prometheus.job=aniway-backend"
      - "prometheus.metrics_path=/actuator/prometheus"
      - "prometheus.port=8085"
      - "prometheus.instance=auth-service"
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: "1.00"
          memory: 1280M
        reservations:
          cpus: "0.35"
          memory: 640M
    depends_on:
      - auth-postgres
    networks:
      - backend

  # Manga Service
  manga-service:
    build:
      context: ./MangaService
      dockerfile: Dockerfile
    expose:
      - "8080"
    environment:
      - SPRING_PROFILES_ACTIVE=prod
      - EUREKA_CLIENT_ENABLED=false
      - POST_SERVICE_URL=http://post-service:8097
      - LEVEL_SERVICE_URL=http://level-service:8098
      - SPRING_DATA_REDIS_HOST=redis
      - SPRING_DATA_REDIS_PORT=6379
      - MANAGEMENT_ENDPOINTS_WEB_EXPOSURE_INCLUDE=health,info,prometheus,metrics
      - MANAGEMENT_ENDPOINT_PROMETHEUS_ENABLED=true
      - MANAGEMENT_METRICS_EXPORT_PROMETHEUS_ENABLED=true
      - MANAGEMENT_ENDPOINT_HEALTH_SHOW_DETAILS=always
      - "prometheus.scrape=true"
      - "prometheus.job=aniway-backend"
      - "prometheus.metrics_path=/actuator/prometheus"
      - "prometheus.port=8081"
      - "prometheus.instance=manga-service"
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: "1.80"
          memory: 2560M
        reservations:
          cpus: "0.75"
          memory: 1536M
    depends_on:
      - manga-postgres
      - chapter-service
      - image-storage-service
    networks:
      - backend

  # Comment Service
  comment-service:
    build:
      context: ./CommentService
      dockerfile: Dockerfile
    environment:
      SPRING_PROFILES_ACTIVE: prod
      SPRING_DATASOURCE_URL: "jdbc:postgresql://comment-postgres:5432/${COMMENT_POSTGRES_DB:?COMMENT_POSTGRES_DB not set}"
      SPRING_DATASOURCE_USERNAME: "${COMMENT_POSTGRES_USER:?COMMENT_POSTGRES_USER not set}"
      SPRING_DATASOURCE_PASSWORD: "${COMMENT_POSTGRES_PASSWORD:?COMMENT_POSTGRES_PASSWORD not set}"
      JWT_SECRET: "${JWT_SECRET:?JWT_SECRET not set}"
      JWT_EXPIRATION: 86400000
      AUTH_SERVICE_URL: http://auth-service:8085
      RABBITMQ_HOST: rabbitmq
      RABBITMQ_PORT: 5672
      RABBITMQ_USERNAME: ${RABBITMQ_USERNAME:?RABBITMQ_USERNAME not set}
      RABBITMQ_PASSWORD: ${RABBITMQ_PASSWORD:?RABBITMQ_PASSWORD not set}
      MANAGEMENT_ENDPOINTS_WEB_EXPOSURE_INCLUDE: health,info,prometheus,metrics
      MANAGEMENT_ENDPOINT_PROMETHEUS_ENABLED: "true"
      MANAGEMENT_METRICS_EXPORT_PROMETHEUS_ENABLED: "true"
      MANAGEMENT_ENDPOINT_HEALTH_SHOW_DETAILS: always
    labels:
      - "prometheus.scrape=true"
      - "prometheus.job=aniway-backend"
      - "prometheus.metrics_path=/actuator/prometheus"
      - "prometheus.port=8086"
      - "prometheus.instance=comment-service"
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: "1.00"
          memory: 1280M
        reservations:
          cpus: "0.35"
          memory: 640M
    depends_on:
      - comment-postgres
      - rabbitmq
    networks:
      - backend

  # Friend Service
  friend-service:
    build:
      context: ./FriendService
      dockerfile: Dockerfile
    environment:
      SPRING_PROFILES_ACTIVE: prod
      FRIEND_DB_URL: "jdbc:postgresql://friend-postgres:5432/${FRIEND_POSTGRES_DB:?FRIEND_POSTGRES_DB not set}"
      FRIEND_DB_USERNAME: "${FRIEND_POSTGRES_USER:?FRIEND_POSTGRES_USER not set}"
      FRIEND_DB_PASSWORD: "${FRIEND_POSTGRES_PASSWORD:?FRIEND_POSTGRES_PASSWORD not set}"
      NOTIFICATION_SERVICE_URL: http://notification-service:8095
      MANAGEMENT_ENDPOINTS_WEB_EXPOSURE_INCLUDE: health,info,prometheus,metrics
      MANAGEMENT_ENDPOINT_PROMETHEUS_ENABLED: "true"
      MANAGEMENT_METRICS_EXPORT_PROMETHEUS_ENABLED: "true"
      MANAGEMENT_ENDPOINT_HEALTH_SHOW_DETAILS: always
    labels:
      - "prometheus.scrape=true"
      - "prometheus.job=aniway-backend"
      - "prometheus.metrics_path=/actuator/prometheus"
      - "prometheus.port=8102"
      - "prometheus.instance=friend-service"
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: "0.75"
          memory: 896M
        reservations:
          cpus: "0.25"
          memory: 384M
    depends_on:
      - friend-postgres
      - notification-service
    networks:
      - backend

  # Message Service
  message-service:
    build:
      context: ./MessageService
      dockerfile: Dockerfile
    environment:
      SPRING_PROFILES_ACTIVE: prod
      DATABASE_URL: "jdbc:postgresql://message-postgres:5432/${MESSAGE_POSTGRES_DB:?MESSAGE_POSTGRES_DB not set}"
      DATABASE_USERNAME: "${MESSAGE_POSTGRES_USER:?MESSAGE_POSTGRES_USER not set}"
      DATABASE_PASSWORD: "${MESSAGE_POSTGRES_PASSWORD:?MESSAGE_POSTGRES_PASSWORD not set}"
      NOTIFICATION_SERVICE_URL: http://notification-service:8095
      FRIEND_SERVICE_URL: http://friend-service:8102
      MANAGEMENT_ENDPOINTS_WEB_EXPOSURE_INCLUDE: health,info,prometheus,metrics
      MANAGEMENT_ENDPOINT_PROMETHEUS_ENABLED: "true"
      MANAGEMENT_METRICS_EXPORT_PROMETHEUS_ENABLED: "true"
      MANAGEMENT_ENDPOINT_HEALTH_SHOW_DETAILS: always
    labels:
      - "prometheus.scrape=true"
      - "prometheus.job=aniway-backend"
      - "prometheus.metrics_path=/actuator/prometheus"
      - "prometheus.port=8103"
      - "prometheus.instance=message-service"
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: "1.40"
          memory: 1536M
        reservations:
          cpus: "0.50"
          memory: 768M
    depends_on:
      - message-postgres
      - friend-service
    networks:
      - backend

  # Chapter Service
  chapter-service:
    build:
      context: ./ChapterService
      dockerfile: Dockerfile
    environment:
      SPRING_PROFILES_ACTIVE: prod
      SPRING_DATASOURCE_URL: "jdbc:postgresql://chapter-postgres:5432/${CHAPTER_POSTGRES_DB:?CHAPTER_POSTGRES_DB not set}"
      SPRING_DATASOURCE_USERNAME: "${CHAPTER_POSTGRES_USER:?CHAPTER_POSTGRES_USER not set}"
      SPRING_DATASOURCE_PASSWORD: "${CHAPTER_POSTGRES_PASSWORD:?CHAPTER_POSTGRES_PASSWORD not set}"
      MANGA_SERVICE_URL: http://manga-service:8081
      IMAGE_STORAGE_SERVICE_URL: http://image-storage-service:8083
      IMAGE_STORAGE_SERVICE_INTERNAL_URL: http://image-storage-service:8083
      MANAGEMENT_ENDPOINTS_WEB_EXPOSURE_INCLUDE: health,info,prometheus,metrics
      MANAGEMENT_ENDPOINT_PROMETHEUS_ENABLED: "true"
      MANAGEMENT_METRICS_EXPORT_PROMETHEUS_ENABLED: "true"
      MANAGEMENT_ENDPOINT_HEALTH_SHOW_DETAILS: always
    labels:
      - "prometheus.scrape=true"
      - "prometheus.job=aniway-backend"
      - "prometheus.metrics_path=/actuator/prometheus"
      - "prometheus.port=8082"
      - "prometheus.instance=chapter-service"
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: "1.40"
          memory: 1792M
        reservations:
          cpus: "0.50"
          memory: 1024M
    depends_on:
      - chapter-postgres
    networks:
      - backend

  # Image Storage Service
  image-storage-service:
    build:
      context: ./ImageStorageService
      dockerfile: Dockerfile
    environment:
      SPRING_PROFILES_ACTIVE: prod
      SPRING_DATASOURCE_URL: "jdbc:postgresql://image-postgres:5432/${IMAGE_POSTGRES_DB:?IMAGE_POSTGRES_DB not set}"
      SPRING_DATASOURCE_USERNAME: "${IMAGE_POSTGRES_USER:?IMAGE_POSTGRES_USER not set}"
      SPRING_DATASOURCE_PASSWORD: "${IMAGE_POSTGRES_PASSWORD:?IMAGE_POSTGRES_PASSWORD not set}"
      MANAGEMENT_ENDPOINTS_WEB_EXPOSURE_INCLUDE: health,info,prometheus,metrics
      MANAGEMENT_ENDPOINT_PROMETHEUS_ENABLED: "true"
      MANAGEMENT_METRICS_EXPORT_PROMETHEUS_ENABLED: "true"
      MANAGEMENT_ENDPOINT_HEALTH_SHOW_DETAILS: always
    labels:
      - "prometheus.scrape=true"
      - "prometheus.job=aniway-backend"
      - "prometheus.metrics_path=/actuator/prometheus"
      - "prometheus.port=8083"
      - "prometheus.instance=image-storage-service"
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: "1.50"
          memory: 2048M
        reservations:
          cpus: "0.55"
          memory: 1280M
    depends_on:
      - image-postgres
    networks:
      - backend

  # Moment Service
  moment-service:
    build:
      context: ./MomentService
      dockerfile: Dockerfile
    environment:
      SPRING_PROFILES_ACTIVE: prod
      SPRING_DATASOURCE_URL: "jdbc:postgresql://moment-postgres:5432/${MOMENT_POSTGRES_DB:?MOMENT_POSTGRES_DB not set}"
      SPRING_DATASOURCE_USERNAME: "${MOMENT_POSTGRES_USER:?MOMENT_POSTGRES_USER not set}"
      SPRING_DATASOURCE_PASSWORD: "${MOMENT_POSTGRES_PASSWORD:?MOMENT_POSTGRES_PASSWORD not set}"
      SPRING_RABBITMQ_HOST: rabbitmq
      SPRING_RABBITMQ_PORT: 5672
      SPRING_RABBITMQ_USERNAME: ${RABBITMQ_USERNAME:?RABBITMQ_USERNAME not set}
      SPRING_RABBITMQ_PASSWORD: ${RABBITMQ_PASSWORD:?RABBITMQ_PASSWORD not set}
      NOTIFICATION_SERVICE_URL: http://notification-service:8095
      XP_EVENTS_EXCHANGE: "${XP_EVENTS_EXCHANGE:?XP_EVENTS_EXCHANGE not set}"
      XP_EVENTS_MOMENT_LIKE_ROUTING_KEY: "${XP_EVENTS_MOMENT_LIKE_ROUTING_KEY:?XP_EVENTS_MOMENT_LIKE_ROUTING_KEY not set}"
      MANAGEMENT_ENDPOINTS_WEB_EXPOSURE_INCLUDE: health,info,prometheus,metrics
      MANAGEMENT_ENDPOINT_PROMETHEUS_ENABLED: "true"
      MANAGEMENT_METRICS_EXPORT_PROMETHEUS_ENABLED: "true"
      MANAGEMENT_ENDPOINT_HEALTH_SHOW_DETAILS: always
    labels:
      - "prometheus.scrape=true"
      - "prometheus.job=aniway-backend"
      - "prometheus.metrics_path=/actuator/prometheus"
      - "prometheus.port=8099"
      - "prometheus.instance=moment-service"
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: "1.30"
          memory: 1536M
        reservations:
          cpus: "0.45"
          memory: 768M
    depends_on:
      - moment-postgres
      - rabbitmq
      - notification-service
    networks:
      - backend

  # Forum Service
  forum-service:
    build:
      context: ./ForumService
      dockerfile: Dockerfile
    environment:
      SPRING_PROFILES_ACTIVE: prod
      SPRING_DATASOURCE_URL: "jdbc:postgresql://forum-postgres:5432/${FORUM_POSTGRES_DB:?FORUM_POSTGRES_DB not set}"
      SPRING_DATASOURCE_USERNAME: "${FORUM_POSTGRES_USER:?FORUM_POSTGRES_USER not set}"
      SPRING_DATASOURCE_PASSWORD: "${FORUM_POSTGRES_PASSWORD:?FORUM_POSTGRES_PASSWORD not set}"
      JWT_SECRET: "${JWT_SECRET:?JWT_SECRET not set}"
      JWT_EXPIRATION: 86400000
      AUTH_SERVICE_URL: http://auth-service:8085
      MANGA_SERVICE_URL: http://manga-service:8081
      MANAGEMENT_ENDPOINTS_WEB_EXPOSURE_INCLUDE: health,info,prometheus,metrics
      MANAGEMENT_ENDPOINT_PROMETHEUS_ENABLED: "true"
      MANAGEMENT_METRICS_EXPORT_PROMETHEUS_ENABLED: "true"
      MANAGEMENT_ENDPOINT_HEALTH_SHOW_DETAILS: always
    labels:
      - "prometheus.scrape=true"
      - "prometheus.job=aniway-backend"
      - "prometheus.metrics_path=/actuator/prometheus"
      - "prometheus.port=8087"
      - "prometheus.instance=forum-service"
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: "1.10"
          memory: 1280M
        reservations:
          cpus: "0.35"
          memory: 640M
    depends_on:
      - forum-postgres
      - auth-service
      - manga-service
    networks:
      - backend

  # ParserService - Java/Spring парсер манги (замена MelonService)
  parser-service:
    build:
      context: ./ParserService
      dockerfile: Dockerfile
    environment:
      - SPRING_PROFILES_ACTIVE=prod
      - PARSER_OUTPUT_PATH=/app/output
      - PARSER_TEMP_PATH=/app/temp
      - MANAGEMENT_ENDPOINTS_WEB_EXPOSURE_INCLUDE=health,info,prometheus,metrics
      - MANAGEMENT_ENDPOINT_PROMETHEUS_ENABLED=true
      - MANAGEMENT_METRICS_EXPORT_PROMETHEUS_ENABLED=true
      - MANAGEMENT_ENDPOINT_HEALTH_SHOW_DETAILS=always
    expose:
      - "8084"
    volumes:
      - parser_data:/app/output
      - parser_temp:/app/temp
    labels:
      - "prometheus.scrape=true"
      - "prometheus.job=aniway-backend"
      - "prometheus.metrics_path=/actuator/prometheus"
      - "prometheus.port=8084"
      - "prometheus.instance=parser-service"
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: "1.80"
          memory: 2560M
        reservations:
          cpus: "0.70"
          memory: 1536M
    networks:
      - backend
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8084/actuator/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  # Databases
  post-postgres:
    image: postgres:15
    environment:
      POSTGRES_DB: "${POST_POSTGRES_DB:?POST_POSTGRES_DB not set}"
      POSTGRES_USER: "${POST_POSTGRES_USER:?POST_POSTGRES_USER not set}"
      POSTGRES_PASSWORD: "${POST_POSTGRES_PASSWORD:?POST_POSTGRES_PASSWORD not set}"
    volumes:
      - post_data:/var/lib/postgresql/data
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: "1.00"
          memory: 1536M
        reservations:
          cpus: "0.30"
          memory: 768M
    networks:
      - backend

  auth-postgres:
    image: postgres:15
    environment:
      POSTGRES_DB: "${AUTH_POSTGRES_DB:?AUTH_POSTGRES_DB not set}"
      POSTGRES_USER: "${AUTH_POSTGRES_USER:?AUTH_POSTGRES_USER not set}"
      POSTGRES_PASSWORD: "${AUTH_POSTGRES_PASSWORD:?AUTH_POSTGRES_PASSWORD not set}"
    volumes:
      - auth_data:/var/lib/postgresql/data
      - ./AuthService/authDB.sql:/docker-entrypoint-initdb.d/init.sql
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: "0.70"
          memory: 1024M
        reservations:
          cpus: "0.25"
          memory: 512M
    networks:
      - backend

  manga-postgres:
    image: postgres:15
    environment:
      POSTGRES_DB: "${MANGA_POSTGRES_DB:?MANGA_POSTGRES_DB not set}"
      POSTGRES_USER: "${MANGA_POSTGRES_USER:?MANGA_POSTGRES_USER not set}"
      POSTGRES_PASSWORD: "${MANGA_POSTGRES_PASSWORD:?MANGA_POSTGRES_PASSWORD not set}"
    volumes:
      - manga_data:/var/lib/postgresql/data
      - ./MangaService/mangaDB.sql:/docker-entrypoint-initdb.d/init.sql
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: "1.10"
          memory: 1792M
        reservations:
          cpus: "0.35"
          memory: 896M
    networks:
      - backend

  comment-postgres:
    image: postgres:15
    environment:
      POSTGRES_DB: "${COMMENT_POSTGRES_DB:?COMMENT_POSTGRES_DB not set}"
      POSTGRES_USER: "${COMMENT_POSTGRES_USER:?COMMENT_POSTGRES_USER not set}"
      POSTGRES_PASSWORD: "${COMMENT_POSTGRES_PASSWORD:?COMMENT_POSTGRES_PASSWORD not set}"
    volumes:
      - comment_data:/var/lib/postgresql/data
      - ./CommentService/commentDB.sql:/docker-entrypoint-initdb.d/init.sql
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: "0.80"
          memory: 1280M
        reservations:
          cpus: "0.25"
          memory: 640M
    networks:
      - backend

  friend-postgres:
    image: postgres:15
    environment:
      POSTGRES_DB: "${FRIEND_POSTGRES_DB:?FRIEND_POSTGRES_DB not set}"
      POSTGRES_USER: "${FRIEND_POSTGRES_USER:?FRIEND_POSTGRES_USER not set}"
      POSTGRES_PASSWORD: "${FRIEND_POSTGRES_PASSWORD:?FRIEND_POSTGRES_PASSWORD not set}"
    volumes:
      - friend_data:/var/lib/postgresql/data
      - ./FriendService/friendDB.sql:/docker-entrypoint-initdb.d/init.sql
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: "0.70"
          memory: 1024M
        reservations:
          cpus: "0.20"
          memory: 512M
    networks:
      - backend

  chapter-postgres:
    image: postgres:15
    environment:
      POSTGRES_DB: "${CHAPTER_POSTGRES_DB:?CHAPTER_POSTGRES_DB not set}"
      POSTGRES_USER: "${CHAPTER_POSTGRES_USER:?CHAPTER_POSTGRES_USER not set}"
      POSTGRES_PASSWORD: "${CHAPTER_POSTGRES_PASSWORD:?CHAPTER_POSTGRES_PASSWORD not set}"
    volumes:
      - chapter_data:/var/lib/postgresql/data
      - ./ChapterService/chapterDB.sql:/docker-entrypoint-initdb.d/init.sql
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: "0.90"
          memory: 1280M
        reservations:
          cpus: "0.25"
          memory: 640M
    networks:
      - backend

  image-postgres:
    image: postgres:15
    environment:
      POSTGRES_DB: "${IMAGE_POSTGRES_DB:?IMAGE_POSTGRES_DB not set}"
      POSTGRES_USER: "${IMAGE_POSTGRES_USER:?IMAGE_POSTGRES_USER not set}"
      POSTGRES_PASSWORD: "${IMAGE_POSTGRES_PASSWORD:?IMAGE_POSTGRES_PASSWORD not set}"
    volumes:
      - image_data:/var/lib/postgresql/data
      - ./ImageStorageService/imageStorageDB.sql:/docker-entrypoint-initdb.d/init.sql
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: "1.20"
          memory: 1792M
        reservations:
          cpus: "0.35"
          memory: 896M
    networks:
      - backend

  moment-postgres:
    image: postgres:15
    environment:
      POSTGRES_DB: "${MOMENT_POSTGRES_DB:?MOMENT_POSTGRES_DB not set}"
      POSTGRES_USER: "${MOMENT_POSTGRES_USER:?MOMENT_POSTGRES_USER not set}"
      POSTGRES_PASSWORD: "${MOMENT_POSTGRES_PASSWORD:?MOMENT_POSTGRES_PASSWORD not set}"
    volumes:
      - moment_data:/var/lib/postgresql/data
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: "0.70"
          memory: 1024M
        reservations:
          cpus: "0.20"
          memory: 512M
    networks:
      - backend

  forum-postgres:
    image: postgres:15
    environment:
      POSTGRES_DB: "${FORUM_POSTGRES_DB:?FORUM_POSTGRES_DB not set}"
      POSTGRES_USER: "${FORUM_POSTGRES_USER:?FORUM_POSTGRES_USER not set}"
      POSTGRES_PASSWORD: "${FORUM_POSTGRES_PASSWORD:?FORUM_POSTGRES_PASSWORD not set}"
    volumes:
      - forum_data:/var/lib/postgresql/data
      - ./ForumService/forumDB.sql:/docker-entrypoint-initdb.d/init.sql
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: "0.80"
          memory: 1280M
        reservations:
          cpus: "0.25"
          memory: 640M
    networks:
      - backend

  # Notification Service
  notification-service:
    build:
      context: ./NotificationService
      dockerfile: Dockerfile
    environment:
      SPRING_PROFILES_ACTIVE: prod
      SPRING_DATASOURCE_URL: "jdbc:postgresql://notification-postgres:5432/${NOTIFICATION_POSTGRES_DB:?NOTIFICATION_POSTGRES_DB not set}"
      SPRING_DATASOURCE_USERNAME: "${NOTIFICATION_POSTGRES_USER:?NOTIFICATION_POSTGRES_USER not set}"
      SPRING_DATASOURCE_PASSWORD: "${NOTIFICATION_POSTGRES_PASSWORD:?NOTIFICATION_POSTGRES_PASSWORD not set}"
      TELEGRAM_BOT_TOKEN: ${TELEGRAM_BOT_TOKEN:?TELEGRAM_BOT_TOKEN not set}
      TELEGRAM_NOTIFICATIONS_ENABLED: "${TELEGRAM_NOTIFICATIONS_ENABLED:?TELEGRAM_NOTIFICATIONS_ENABLED not set}"
      TELEGRAM_NOTIFICATIONS_AGGREGATE_WINDOW_SECONDS: "${TELEGRAM_NOTIFICATIONS_AGGREGATE_WINDOW_SECONDS:?TELEGRAM_NOTIFICATIONS_AGGREGATE_WINDOW_SECONDS not set}"
      TELEGRAM_NOTIFICATIONS_MAX_RETRIES: "${TELEGRAM_NOTIFICATIONS_MAX_RETRIES:?TELEGRAM_NOTIFICATIONS_MAX_RETRIES not set}"
      TELEGRAM_NOTIFICATIONS_RETRY_BACKOFF_MILLIS: "${TELEGRAM_NOTIFICATIONS_RETRY_BACKOFF_MILLIS:?TELEGRAM_NOTIFICATIONS_RETRY_BACKOFF_MILLIS not set}"
      TELEGRAM_NOTIFICATIONS_CHAPTER_LINK_TEMPLATE: "${TELEGRAM_NOTIFICATIONS_CHAPTER_LINK_TEMPLATE:?TELEGRAM_NOTIFICATIONS_CHAPTER_LINK_TEMPLATE not set}"
      TELEGRAM_NOTIFICATIONS_MANGA_LINK_TEMPLATE: "${TELEGRAM_NOTIFICATIONS_MANGA_LINK_TEMPLATE:?TELEGRAM_NOTIFICATIONS_MANGA_LINK_TEMPLATE not set}"
      TELEGRAM_NOTIFICATIONS_SITE_BASE_URL: "${TELEGRAM_NOTIFICATIONS_SITE_BASE_URL:?TELEGRAM_NOTIFICATIONS_SITE_BASE_URL not set}"
      MANAGEMENT_ENDPOINTS_WEB_EXPOSURE_INCLUDE: health,info,prometheus,metrics
      MANAGEMENT_ENDPOINT_PROMETHEUS_ENABLED: "true"
      MANAGEMENT_METRICS_EXPORT_PROMETHEUS_ENABLED: "true"
      MANAGEMENT_ENDPOINT_HEALTH_SHOW_DETAILS: always
    labels:
      - "prometheus.scrape=true"
      - "prometheus.job=aniway-backend"
      - "prometheus.metrics_path=/actuator/prometheus"
      - "prometheus.port=8095"
      - "prometheus.instance=notification-service"
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: "0.80"
          memory: 896M
        reservations:
          cpus: "0.25"
          memory: 384M
    depends_on:
      - notification-postgres
    networks:
      - backend

  notification-postgres:
    image: postgres:15
    environment:
      POSTGRES_DB: "${NOTIFICATION_POSTGRES_DB:?NOTIFICATION_POSTGRES_DB not set}"
      POSTGRES_USER: "${NOTIFICATION_POSTGRES_USER:?NOTIFICATION_POSTGRES_USER not set}"
      POSTGRES_PASSWORD: "${NOTIFICATION_POSTGRES_PASSWORD:?NOTIFICATION_POSTGRES_PASSWORD not set}"
    volumes:
      - notification_data:/var/lib/postgresql/data
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: "0.70"
          memory: 1024M
        reservations:
          cpus: "0.20"
          memory: 512M
    networks:
      - backend

  message-postgres:
    image: postgres:15
    environment:
      POSTGRES_DB: "${MESSAGE_POSTGRES_DB:?MESSAGE_POSTGRES_DB not set}"
      POSTGRES_USER: "${MESSAGE_POSTGRES_USER:?MESSAGE_POSTGRES_USER not set}"
      POSTGRES_PASSWORD: "${MESSAGE_POSTGRES_PASSWORD:?MESSAGE_POSTGRES_PASSWORD not set}"
    volumes:
      - message_data:/var/lib/postgresql/data
      - ./MessageService/messageDB.sql:/docker-entrypoint-initdb.d/init.sql
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: "0.90"
          memory: 1280M
        reservations:
          cpus: "0.30"
          memory: 640M
    networks:
      - backend

  # Post Service
  post-service:
    build:
      context: ./PostService
      dockerfile: Dockerfile
    environment:
      SPRING_PROFILES_ACTIVE: prod
      SPRING_DATASOURCE_URL: "jdbc:postgresql://post-postgres:5432/${POST_POSTGRES_DB:?POST_POSTGRES_DB not set}"
      SPRING_DATASOURCE_USERNAME: "${POST_POSTGRES_USER:?POST_POSTGRES_USER not set}"
      SPRING_DATASOURCE_PASSWORD: "${POST_POSTGRES_PASSWORD:?POST_POSTGRES_PASSWORD not set}"
      IMAGE_STORAGE_SERVICE_URL: http://image-storage-service:8083
      RABBITMQ_HOST: rabbitmq
      RABBITMQ_PORT: 5672
      RABBITMQ_USERNAME: ${RABBITMQ_USERNAME:?RABBITMQ_USERNAME not set}
      RABBITMQ_PASSWORD: ${RABBITMQ_PASSWORD:?RABBITMQ_PASSWORD not set}
      MANAGEMENT_ENDPOINTS_WEB_EXPOSURE_INCLUDE: health,info,prometheus,metrics
      MANAGEMENT_ENDPOINT_PROMETHEUS_ENABLED: "true"
      MANAGEMENT_METRICS_EXPORT_PROMETHEUS_ENABLED: "true"
      MANAGEMENT_ENDPOINT_HEALTH_SHOW_DETAILS: always
    labels:
      - "prometheus.scrape=true"
      - "prometheus.job=aniway-backend"
      - "prometheus.metrics_path=/actuator/prometheus"
      - "prometheus.port=8097"
      - "prometheus.instance=post-service"
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: "1.40"
          memory: 1536M
        reservations:
          cpus: "0.50"
          memory: 768M
    depends_on:
      - post-postgres
      - image-storage-service
      - rabbitmq
    networks:
      - backend

  # Level Service
  level-service:
    build:
      context: ./LevelService
      dockerfile: Dockerfile
    environment:
      SPRING_PROFILES_ACTIVE: prod
      SPRING_DATASOURCE_URL: "jdbc:postgresql://level-postgres:5432/${LEVEL_POSTGRES_DB:?LEVEL_POSTGRES_DB not set}"
      SPRING_DATASOURCE_USERNAME: "${LEVEL_POSTGRES_USER:?LEVEL_POSTGRES_USER not set}"
      SPRING_DATASOURCE_PASSWORD: "${LEVEL_POSTGRES_PASSWORD:?LEVEL_POSTGRES_PASSWORD not set}"
      RABBITMQ_HOST: rabbitmq
      RABBITMQ_PORT: 5672
      RABBITMQ_USERNAME: ${RABBITMQ_USERNAME:?RABBITMQ_USERNAME not set}
      RABBITMQ_PASSWORD: ${RABBITMQ_PASSWORD:?RABBITMQ_PASSWORD not set}
      MANAGEMENT_ENDPOINTS_WEB_EXPOSURE_INCLUDE: health,info,prometheus,metrics
      MANAGEMENT_ENDPOINT_PROMETHEUS_ENABLED: "true"
      MANAGEMENT_METRICS_EXPORT_PROMETHEUS_ENABLED: "true"
      MANAGEMENT_ENDPOINT_HEALTH_SHOW_DETAILS: always
    labels:
      - "prometheus.scrape=true"
      - "prometheus.job=aniway-backend"
      - "prometheus.metrics_path=/actuator/prometheus"
      - "prometheus.port=8098"
      - "prometheus.instance=level-service"
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: "0.80"
          memory: 896M
        reservations:
          cpus: "0.25"
          memory: 384M
    depends_on:
      - level-postgres
      - rabbitmq
    networks:
      - backend

  level-postgres:
    image: postgres:15
    environment:
      POSTGRES_DB: "${LEVEL_POSTGRES_DB:?LEVEL_POSTGRES_DB not set}"
      POSTGRES_USER: "${LEVEL_POSTGRES_USER:?LEVEL_POSTGRES_USER not set}"
      POSTGRES_PASSWORD: "${LEVEL_POSTGRES_PASSWORD:?LEVEL_POSTGRES_PASSWORD not set}"
    volumes:
      - level_data:/var/lib/postgresql/data
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: "0.70"
          memory: 1024M
        reservations:
          cpus: "0.20"
          memory: 512M
    networks:
      - backend

  # RabbitMQ broker
  rabbitmq:
    image: rabbitmq:3.13-management
    environment:
      RABBITMQ_DEFAULT_USER: ${RABBITMQ_USERNAME:?RABBITMQ_USERNAME not set}
      RABBITMQ_DEFAULT_PASS: ${RABBITMQ_PASSWORD:?RABBITMQ_PASSWORD not set}
    expose:
      - "5672"
      - "15672"
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: "1.20"
          memory: 1536M
        reservations:
          cpus: "0.45"
          memory: 640M
    networks:
      - backend

  redis:
    image: redis:7.4-alpine
    command: ["redis-server", "--save", "60", "1000", "--loglevel", "warning"]
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: "0.50"
          memory: 512M
        reservations:
          cpus: "0.20"
          memory: 256M
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
    volumes:
      - redis_data:/data
    networks:
      - backend

volumes:
  caddy_data:
  caddy_config:
  auth_data:
  manga_data:
  comment_data:
  friend_data:
  chapter_data:
  image_data:
  moment_data:
  forum_data:
  parser_data:
  parser_temp:
  notification_data:
  message_data:
  post_data:
  level_data:
  redis_data:

networks:
  edge:
    driver: bridge
  backend:
    driver: bridge
