# Конвертация HTML в Markdown для описаний манги

## Дата
2025-10-07

## Проблема

Описания манги из MangaLib содержат HTML-теги форматирования:
- `<b>`, `<strong>` — жирный текст
- `<i>`, `<em>` — курсив
- `<br>`, `<br/>` — перенос строки
- `<p>` — параграф

**Пример из логов:**
```html
<b><i>Прототип манги «Клинок, рассекающий демонов».</i></b><br><br><b><i></i></b>Город встревожен страшным инцидентом. Совершено нападение на человека. Преступником оказался вампир… Что за парень осмелился направить свой меч против него?!<br>
```

На фронтенде эти теги отображаются как есть, без форматирования.

## Решение

Добавлена конвертация HTML в Markdown при импорте манги.

### Реализация

**Метод `convertHtmlToMarkdown()`** в `MelonIntegrationService`:

```java
private String convertHtmlToMarkdown(String html) {
    if (html == null || html.isEmpty()) {
        return html;
    }

    String markdown = html
        // <br> → перенос строки
        .replaceAll("<br\\s*/?>", "\n")
        // <p> → двойной перенос строки
        .replaceAll("</p>\\s*<p>", "\n\n")
        .replaceAll("</?p>", "\n\n")
        // <b>, <strong> → **bold**
        .replaceAll("<b>(.*?)</b>", "**$1**")
        .replaceAll("<strong>(.*?)</strong>", "**$1**")
        // <i>, <em> → *italic*
        .replaceAll("<i>(.*?)</i>", "*$1*")
        .replaceAll("<em>(.*?)</em>", "*$1*")
        // <b><i> → ***bold+italic***
        .replaceAll("<b>\\s*<i>(.*?)</i>\\s*</b>", "***$1***")
        .replaceAll("<i>\\s*<b>(.*?)</b>\\s*</i>", "***$1***")
        .replaceAll("<strong>\\s*<em>(.*?)</em>\\s*</strong>", "***$1***")
        .replaceAll("<em>\\s*<strong>(.*?)</strong>\\s*</em>", "***$1***")
        // Убираем все остальные HTML-теги
        .replaceAll("<[^>]*>", "")
        // Нормализуем пробелы
        .replaceAll(" +", " ")
        // Нормализуем переносы строк
        .replaceAll("\n{3,}", "\n\n")
        .trim();

    return markdown;
}
```

**Применение в `createMangaFromData()`:**

```java
// Обрабатываем описание
String description = (String) mangaInfo.get("description");
if (description != null && !description.trim().isEmpty()) {
    // Конвертируем HTML-теги в Markdown
    description = convertHtmlToMarkdown(description.trim());
    manga.setDescription(description);
}
```

## Результат конвертации

### До (HTML):
```html
<b><i>Прототип манги «Клинок, рассекающий демонов».</i></b><br><br><b><i></i></b>Город встревожен страшным инцидентом. Совершено нападение на человека. Преступником оказался вампир… Что за парень осмелился направить свой меч против него?!<br>
```

### После (Markdown):
```markdown
***Прототип манги «Клинок, рассекающий демонов».***

Город встревожен страшным инцидентом. Совершено нападение на человека. Преступником оказался вампир… Что за парень осмелился направить свой меч против него?!
```

## Поддерживаемые теги

| HTML | Markdown | Описание |
|------|----------|----------|
| `<b>text</b>` | `**text**` | Жирный текст |
| `<strong>text</strong>` | `**text**` | Жирный текст |
| `<i>text</i>` | `*text*` | Курсив |
| `<em>text</em>` | `*text*` | Курсив |
| `<b><i>text</i></b>` | `***text***` | Жирный + курсив |
| `<br>`, `<br/>` | `\n` | Перенос строки |
| `<p>text</p>` | `\n\ntext\n\n` | Параграф |
| Другие теги | (удаляются) | Неизвестные теги убираются |

## Преимущества

1. **Совместимость с фронтендом**: Фронтенд уже имеет Markdown-рендерер
2. **Чистый вывод**: Нет лишних HTML-тегов в UI
3. **Сохранение форматирования**: Жирный, курсив, переносы строк сохраняются
4. **Безопасность**: HTML-теги удаляются, предотвращая XSS
5. **Читаемость**: Markdown более читабельен в исходном виде

## Файлы изменены

### Бэкенд

**MelonIntegrationService.java**:
- Добавлен метод `convertHtmlToMarkdown()`
- Обновлена обработка description в `createMangaFromData()` (2 места: строки ~464 и ~971)

### Фронтенд

**MangaPage.tsx**:
- Добавлен импорт `MarkdownRenderer`
- Обновлён блок описания для рендеринга Markdown с классами `prose prose-invert max-w-none markdown-body`

**MangaTooltip.tsx**:
- Добавлен импорт `MarkdownRenderer`
- Обновлён блок описания в тултипе для рендеринга Markdown

**HomePage.tsx**:
- Добавлен импорт `MarkdownRenderer`
- Обновлён блок Featured-секции для рендеринга Markdown

## Тестирование

После пересборки MangaService и повторного импорта манги проверьте:

1. Описание отображается с правильным форматированием (жирный, курсив)
2. Переносы строк работают корректно
3. HTML-теги не отображаются в UI
4. Фронтенд корректно рендерит Markdown

**Пример теста:**
```bash
# Запустить импорт манги с HTML-описанием
curl -X POST http://localhost:8083/api/manga/auto-parse?limit=1

# Проверить описание в базе данных
# Должно быть в формате Markdown, а не HTML
```

## Примечания

- Метод обрабатывает только базовые HTML-теги форматирования
- Вложенные и сложные структуры упрощаются
- Неизвестные теги удаляются без сохранения содержимого
- Множественные пробелы и переносы нормализуются

## Связанные документы
- Frontend Markdown рендерер (уже реализован на фронтенде)
