# 🎯 Руководство по автопарсингу и автообновлению манги

## 📱 Как использовать фронтенд

### Доступ к функциям
1. Войдите в систему как **администратор**
2. Перейдите в раздел **"/admin/manga"** или **"/admin"**
3. Выберите вкладку **"Автоматизация"** (иконка RefreshCw)

---

## 🔄 Автопарсинг манги

### Что это?
Автоматический парсинг, билдинг и импорт манги из MangaLib с проверкой на дубликаты.

### Как использовать:

1. **Введите slug'ы манги** в текстовое поле (по одному на строку):
   ```
   one-punch-man
   overlord
   berserk
   ```

2. **Нажмите "Запустить автопарсинг"**

3. **Следите за прогрессом:**
   - Статус задачи (`pending` → `running` → `completed`/`failed`)
   - Прогресс-бар (0% → 100%)
   - Обработано slug'ов
   - Импортировано новых
   - Пропущено (дубликаты)
   - Ошибки

### Что происходит:
```
Для каждого slug:
1. Проверка дубликата (existsByMelonSlug) ✅
   → Если существует → пропустить
2. Парсинг через MelonService (/parse)
3. Билдинг манги (/build)
4. Импорт в систему (сохранение melonSlug ✅)
5. Удаление из MelonService (/delete)
```

### Результат:
- ✅ **Импортировано:** Новые манги добавлены с `melonSlug`
- ⏭️ **Пропущено:** Дубликаты (уже существуют в системе)
- ❌ **Ошибки:** Список slug'ов с проблемами

---

## 🔄 Автообновление манги

### Что это?
Проверка всех манг в системе на наличие новых глав и их автоматический импорт.

### Как использовать:

1. **Нажмите "Запустить автообновление"**

2. **Следите за прогрессом:**
   - Статус задачи
   - Прогресс-бар
   - Всего манг для проверки
   - Проверено манг
   - Обновлено манг
   - Добавлено глав
   - Ошибки

### Что происходит:
```
1. Получение всех манг с melonSlug != null ✅
2. Для каждой манги:
   - Получение существующих глав
   - Парсинг через MelonService (/parse) ✅
   - Получение инфо (/manga-info/{slug}) ✅
   - Фильтрация новых глав в Java ✅
   - Импорт новых глав с страницами ✅
```

### Результат:
- 📊 **Обновлено манг:** Количество манг с новыми главами
- 📖 **Добавлено глав:** Общее количество импортированных глав
- 🖼️ **Страницы:** Автоматически импортированы для всех глав ✅
- ❌ **Ошибки:** Список манг с проблемами

---

## 🎨 Интерфейс

### Вкладка "Автоматизация"
```
┌─────────────────────────────────────────────────────────┐
│ 📋 Автопарсинг манги                                    │
├─────────────────────────────────────────────────────────┤
│ Список slug'ов (по одному на строку):                  │
│ ┌─────────────────────────────────────────────────────┐ │
│ │ one-punch-man                                       │ │
│ │ overlord                                            │ │
│ │ berserk                                             │ │
│ └─────────────────────────────────────────────────────┘ │
│                                                         │
│ [ 📥 Запустить автопарсинг ]                           │
│                                                         │
│ ┌─────────────────────────────────────────────────────┐ │
│ │ 🔄 Автопарсинг                         [running]    │ │
│ │ Парсинг и импорт манги...                          │ │
│ │                                                     │ │
│ │ ████████████████░░░░░░░░░░ 60%                     │ │
│ │                                                     │ │
│ │ Всего: 3        Обработано: 2                      │ │
│ │ Импортировано: 1    Пропущено: 1                   │ │
│ │ Ошибок: 0                                           │ │
│ └─────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────┐
│ 🔄 Автообновление манги                                 │
├─────────────────────────────────────────────────────────┤
│ ⚠️ Этот процесс проверит все манги в системе           │
│    на наличие новых глав и автоматически               │
│    импортирует их. Это может занять время.             │
│                                                         │
│ [ 🔄 Запустить автообновление ]                        │
│                                                         │
│ ┌─────────────────────────────────────────────────────┐ │
│ │ 🔄 Автообновление                    [completed]    │ │
│ │ Обновление завершено!                              │ │
│ │                                                     │ │
│ │ ████████████████████████████ 100%                  │ │
│ │                                                     │ │
│ │ Всего манг: 25      Проверено: 25                  │ │
│ │ Обновлено манг: 3   Добавлено глав: 12             │ │
│ │ Ошибок: 0                                           │ │
│ │                                                     │ │
│ │ 📚 Обновленные манги:                               │ │
│ │ • One Punch Man                                     │ │
│ │ • Overlord                                          │ │
│ │ • Berserk                                           │ │
│ └─────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────┘
```

---

## 🔗 API Endpoints (Backend)

### Автопарсинг
- **POST** `/api/parser/auto-parse`
  ```json
  {
    "slugs": ["one-punch-man", "overlord"],
    "page": 1
  }
  ```
  **Ответ:**
  ```json
  {
    "task_id": "uuid",
    "status": "pending",
    "total_slugs": 2,
    "processed_slugs": 0
  }
  ```

- **GET** `/api/parser/auto-parse/status/{taskId}`
  **Ответ:**
  ```json
  {
    "task_id": "uuid",
    "status": "completed",
    "progress": 100,
    "message": "Автопарсинг завершен",
    "total_slugs": 2,
    "processed_slugs": 2,
    "imported_slugs": ["one-punch-man"],
    "skipped_slugs": ["overlord"],
    "failed_slugs": []
  }
  ```

### Автообновление
- **POST** `/api/parser/auto-update`
  **Ответ:**
  ```json
  {
    "task_id": "uuid",
    "status": "pending",
    "total_mangas": 25,
    "processed_mangas": 0
  }
  ```

- **GET** `/api/parser/auto-update/status/{taskId}`
  **Ответ:**
  ```json
  {
    "task_id": "uuid",
    "status": "completed",
    "progress": 100,
    "message": "Автообновление завершено",
    "total_mangas": 25,
    "processed_mangas": 25,
    "updated_mangas": ["One Punch Man", "Overlord"],
    "new_chapters_count": 12,
    "failed_mangas": []
  }
  ```

---

## ✅ Что исправлено

### До исправлений ❌
- melonSlug не сохранялся → дубликаты не определялись
- Автообновление не находило манги (melonSlug == null)
- Вызов несуществующих endpoints MelonService
- Страницы глав не импортировались (заглушка)

### После исправлений ✅
- melonSlug сохраняется корректно
- Дубликаты определяются и пропускаются
- Используются только существующие endpoints
- Страницы импортируются полностью
- Устойчивое сравнение номеров глав

---

## 🧪 Тестирование

### Тест 1: Автопарсинг с дубликатами
1. Добавить манги: `one-punch-man`, `overlord`
2. Проверить в БД: `SELECT * FROM manga WHERE melon_slug IS NOT NULL`
3. Повторить автопарсинг с теми же slug'ами
4. **Ожидаемый результат:** Пропущено: 2, Импортировано: 0

### Тест 2: Автообновление
1. Убедиться, что есть манги с `melonSlug != null`
2. Запустить автообновление
3. **Ожидаемый результат:** 
   - Найдено N манг для обновления
   - Добавлено M новых глав
   - Страницы импортированы

### Тест 3: Проверка страниц
```sql
SELECT c.chapter_number, COUNT(mp.page_number) as pages
FROM chapter c
LEFT JOIN manga_pages mp ON mp.chapter_id = c.id
WHERE c.manga_id = 1
GROUP BY c.chapter_number
ORDER BY c.chapter_number DESC;
```
**Ожидаемый результат:** У каждой главы должны быть страницы

---

## 📊 Мониторинг

### Логи в реальном времени
```bash
# Docker
docker logs manga-service -f | grep -E "Автопарсинг|Автообновление|melonSlug"

# Windows PowerShell
docker logs manga-service -f | Select-String "Автопарсинг|Автообновление|melonSlug"
```

### Проверка БД
```sql
-- Манги с melonSlug
SELECT COUNT(*) FROM manga WHERE melon_slug IS NOT NULL;

-- Последние добавленные главы
SELECT m.title, c.chapter_number, c.created_at
FROM chapter c
JOIN manga m ON m.id = c.manga_id
ORDER BY c.created_at DESC LIMIT 10;

-- Статистика страниц
SELECT COUNT(*) FROM manga_pages;
```

---

## 🎉 Готово!

Система автопарсинга и автообновления полностью функциональна и доступна через фронтенд в разделе администратора!

**Путь:** `/admin/manga` → Вкладка "Автоматизация"

**Требования:** Права администратора

**Статус:** ✅ Готов к использованию
