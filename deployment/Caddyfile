{
    email {$ACME_EMAIL}
}

https://aniway.space {
    encode zstd gzip
    header {
        Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
        Referrer-Policy "no-referrer-when-downgrade"
        X-Content-Type-Options "nosniff"
    }

    handle /.well-known/acme-challenge/* {
        root * /srv/verifications
        file_server
    }

    handle_path /prometheus* {
        reverse_proxy aniway-prometheus:9090
    }

    handle /grafana {
        redir /grafana/ 302
    }

    handle_path /grafana/* {
        reverse_proxy aniway-grafana:3000
    }

    handle_path /alertmanager* {
        reverse_proxy aniway-alertmanager:9093
    }

    # Server-Sent Events (SSE) for notifications
    @sse {
        path /api/notifications/stream*
    }
    handle @sse {
        reverse_proxy gateway-service:8080 {
            flush_interval -1
            header_up Connection "keep-alive"
            header_up Cache-Control "no-cache"
        }
    }

    # WebSocket connections
    @websockets {
        path /api/ws/* /ws/*
    }
    handle @websockets {
        reverse_proxy gateway-service:8080 {
            header_up Connection "Upgrade"
            header_up Upgrade "websocket"
        }
    }

    # API requests to Gateway Service
    handle /api/* {
        reverse_proxy gateway-service:8080
    }

    # Telegram webhooks
    handle /telegram/* {
        reverse_proxy gateway-service:8080
    }

    # All other requests to frontend
    reverse_proxy aniway-frontend:80
}

http://aniway.space {
    handle /.well-known/acme-challenge/* {
        root * /srv/verifications
        file_server
    }

    redir https://aniway.space{uri}
}
